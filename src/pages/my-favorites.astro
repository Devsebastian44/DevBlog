---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

const title = "My Favorites | DevBlog";
---

<Layout title={title}>
    <Header />

    <main
        class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 w-full min-h-[60vh]"
    >
        <div class="mb-10">
            <h1
                class="text-3xl font-extrabold text-slate-900 dark:text-white flex items-center gap-3"
            >
                <span class="material-icons text-primary">bookmark</span>
                My Favorites
            </h1>
            <p class="text-slate-500 mt-2">Articles you've saved for later.</p>
        </div>

        <div
            id="favorites-grid"
            class="grid md:grid-cols-2 lg:grid-cols-3 gap-8"
        >
            <!-- Posts will be injected here -->
            <div class="col-span-full py-20 text-center animate-pulse">
                <p class="text-slate-400">Loading your favorites...</p>
            </div>
        </div>

        <div id="no-favorites" class="hidden py-20 text-center">
            <div
                class="w-20 h-20 bg-slate-100 dark:bg-[#162a2f] rounded-full flex items-center justify-center mx-auto mb-4"
            >
                <span class="material-icons text-slate-400 text-3xl"
                    >bookmark_border</span
                >
            </div>
            <h2 class="text-xl font-bold text-slate-700 dark:text-slate-300">
                No favorites saved
            </h2>
            <p class="text-slate-500 mt-2">
                Save articles you want to read later and they will appear here!
            </p>
            <a
                href="/archive"
                class="mt-6 inline-block px-6 py-2 bg-primary text-white rounded-full font-bold hover:bg-primary-dark transition-all"
                >Explore Articles</a
            >
        </div>
    </main>

    <Footer />

    <script>
        import { supabase } from "../lib/supabase";

        const favoritesGrid = document.getElementById("favorites-grid");
        const noFavorites = document.getElementById("no-favorites");

        async function loadFavorites() {
            const {
                data: { session },
            } = await supabase.auth.getSession();

            if (!session) {
                window.location.href = "/login";
                return;
            }

            const { data: favorites, error } = await supabase
                .from("bookmarks")
                .select("post_slug")
                .eq("user_id", session.user.id)
                .order("created_at", { ascending: false });

            if (error || !favorites || favorites.length === 0) {
                if (favoritesGrid) favoritesGrid.classList.add("hidden");
                if (noFavorites) noFavorites.classList.remove("hidden");
                return;
            }

            renderFavorites(favorites);
        }

        function renderFavorites(favorites) {
            if (!favoritesGrid) return;

            favoritesGrid.innerHTML = favorites
                .map(
                    (fav) => `
                <a href="/posts/${fav.post_slug}" class="group bg-white dark:bg-[#162a2f] border border-slate-200 dark:border-[#224249] rounded-2xl overflow-hidden hover:shadow-xl hover:shadow-primary/10 transition-all p-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-xs font-bold text-primary uppercase tracking-widest">Saved Article</span>
                        <span class="material-icons text-primary/40 group-hover:text-primary transition-colors">arrow_forward</span>
                    </div>
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white group-hover:text-primary transition-colors mb-2 truncate">
                        ${fav.post_slug
                            .split("-")
                            .map(
                                (word) =>
                                    word.charAt(0).toUpperCase() +
                                    word.slice(1),
                            )
                            .join(" ")}
                    </h3>
                    <p class="text-sm text-slate-500 line-clamp-2">Continue reading this saved piece.</p>
                </a>
            `,
                )
                .join("");
        }

        loadFavorites();
    </script>
</Layout>
