---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
---

<Layout title="Account Settings | DevBlog">
    <Header />

    <main
        class="min-h-screen bg-slate-50 dark:bg-[#0b1618] py-12 px-4 sm:px-6 lg:px-8 text-slate-900 dark:text-white"
    >
        <div class="max-w-3xl mx-auto">
            <div class="mb-8">
                <h1 class="text-3xl font-extrabold tracking-tight">
                    Account Settings
                </h1>
                <p class="mt-2 text-slate-600 dark:text-slate-400">
                    Manage your profile and account.
                </p>
            </div>

            <div class="space-y-6">
                <!-- Public Profile -->
                <div
                    class="bg-white dark:bg-[#162a2f] shadow-xl rounded-2xl border border-slate-200 dark:border-[#224249] overflow-hidden"
                >
                    <div
                        class="px-6 py-4 border-b border-slate-100 dark:border-[#224249] bg-slate-50/50 dark:bg-[#1c363c]"
                    >
                        <h2 class="text-lg font-bold flex items-center gap-2">
                            <span class="material-icons text-primary"
                                >person</span
                            >
                            Public Profile
                        </h2>
                    </div>
                    <div
                        class="p-6 flex flex-col sm:flex-row items-center gap-8"
                    >
                        <div
                            class="w-24 h-24 rounded-full bg-primary flex items-center justify-center text-white text-3xl font-bold shadow-lg border-4 border-white dark:border-[#162a2f]"
                        >
                            <span id="settings-user-initials">U</span>
                            <img
                                id="settings-user-avatar"
                                src=""
                                alt=""
                                class="hidden w-full h-full object-cover rounded-full"
                            />
                        </div>
                        <div class="flex-1 w-full space-y-4">
                            <div>
                                <label
                                    class="block text-sm font-bold mb-1 font-mono uppercase tracking-tighter text-slate-500"
                                    >Email Address</label
                                >
                                <input
                                    type="email"
                                    id="settings-email"
                                    disabled
                                    class="w-full px-4 py-2 bg-slate-50 dark:bg-[#0b1618] border border-slate-200 dark:border-[#224249] rounded-xl text-slate-500 cursor-not-allowed"
                                />
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-bold mb-1 font-mono uppercase tracking-tighter text-slate-500"
                                    >Full Name</label
                                >
                                <div class="flex gap-2">
                                    <input
                                        type="text"
                                        id="settings-name"
                                        class="flex-1 px-4 py-2 bg-white dark:bg-[#0b1618] border border-slate-200 dark:border-[#224249] rounded-xl outline-none focus:ring-2 focus:ring-primary/20"
                                        placeholder="Your name"
                                    />
                                    <button
                                        id="update-name-btn"
                                        class="px-4 py-2 bg-primary text-white rounded-xl font-bold hover:bg-primary-dark transition-all shadow-lg shadow-primary/20 cursor-pointer"
                                        >Update</button
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div
                    class="bg-red-50 dark:bg-red-950/10 border border-red-200 dark:border-red-900/50 rounded-2xl overflow-hidden mt-12"
                >
                    <div
                        class="px-6 py-4 border-b border-red-100 dark:border-red-900/30 bg-red-100/50 dark:bg-red-950/20"
                    >
                        <h2
                            class="text-lg font-bold text-red-800 dark:text-red-400 flex items-center gap-2"
                        >
                            <span class="material-icons">warning</span> Danger Zone
                        </h2>
                    </div>
                    <div
                        class="p-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4"
                    >
                        <div>
                            <h3
                                class="text-md font-bold text-red-900 dark:text-red-300"
                            >
                                Delete Account
                            </h3>
                            <p
                                class="text-sm text-red-700 dark:text-red-400 mt-1"
                            >
                                Permanently remove your account and all of your
                                data. This is irreversible.
                            </p>
                        </div>
                        <div id="delete-init-container">
                            <button
                                id="delete-account-btn-init"
                                type="button"
                                class="group relative px-5 py-2.5 bg-gradient-to-tr from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white rounded-xl font-display uppercase tracking-wider text-xs font-bold transition-all shadow-lg shadow-red-500/10 hover:shadow-red-500/30 cursor-pointer overflow-hidden active:scale-95 flex items-center gap-2 border border-red-400/20"
                            >
                                <span
                                    class="material-icons text-lg group-hover:rotate-12 transition-transform"
                                    >delete_forever</span
                                >
                                <span>Delete Account</span>
                            </button>
                        </div>

                        <!-- Custom Confirmation Area (Initially Hidden) -->
                        <div
                            id="confirm-delete-area"
                            class="hidden bg-white dark:bg-red-950/20 p-4 rounded-xl border border-red-200 dark:border-red-900 animate-in fade-in slide-in-from-top-4 duration-300"
                        >
                            <p
                                class="text-sm font-bold text-red-700 dark:text-red-400 mb-4"
                            >
                                ⚠ ARE YOU ABSOLUTELY SURE? This will permanently
                                erase your likes, favorites, and comments. This
                                cannot be undone.
                            </p>
                            <div class="flex gap-3">
                                <button
                                    id="delete-account-btn-final"
                                    type="button"
                                    class="flex-1 px-6 py-3 bg-gradient-to-r from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 text-white rounded-xl font-bold text-sm transition-all shadow-lg shadow-red-900/20 active:scale-95 border border-red-400/20 flex items-center justify-center gap-2"
                                >
                                    <span class="material-icons text-lg"
                                        >dangerous</span
                                    >
                                    YES, DELETE PERMANENTLY
                                </button>
                                <button
                                    id="cancel-delete-btn"
                                    type="button"
                                    class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg font-bold text-sm hover:bg-slate-300 dark:hover:bg-slate-600 transition-all"
                                >
                                    No, Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-6 flex justify-center">
                    <button
                        id="settings-logout-btn"
                        class="text-red-500 font-bold hover:underline flex items-center gap-2 cursor-pointer"
                    >
                        <span class="material-icons">logout</span> Logout
                    </button>
                </div>
            </div>
        </div>
    </main>

    <Footer />

    <script>
        import { supabase } from "../lib/supabase";

        const emailInput = document.getElementById(
            "settings-email",
        ) as HTMLInputElement;
        const nameInput = document.getElementById(
            "settings-name",
        ) as HTMLInputElement;
        const initialsSpan = document.getElementById("settings-user-initials");
        const avatarImg = document.getElementById(
            "settings-user-avatar",
        ) as HTMLImageElement;
        const updateNameBtn = document.getElementById("update-name-btn");
        const deleteBtnInit = document.getElementById(
            "delete-account-btn-init",
        );
        const deleteArea = document.getElementById("confirm-delete-area");
        const deleteBtnFinal = document.getElementById(
            "delete-account-btn-final",
        );
        const cancelDeleteBtn = document.getElementById("cancel-delete-btn");
        const logoutBtn = document.getElementById("settings-logout-btn");

        async function init() {
            try {
                const {
                    data: { session },
                } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = "/login";
                    return;
                }
                const user = session.user;
                if (emailInput) emailInput.value = user.email || "";
                if (nameInput)
                    nameInput.value = user.user_metadata?.full_name || "";
                updateUI(user);
            } catch (err) {
                console.error("Init error", err);
            }
        }

        function updateUI(user: any) {
            if (!user) return;
            const initials = user.user_metadata?.full_name
                ? user.user_metadata.full_name
                      .split(" ")
                      .map((n: string) => n[0])
                      .join("")
                      .toUpperCase()
                : user.email?.slice(0, 2).toUpperCase() || "U";

            if (initialsSpan) initialsSpan.textContent = initials;
            if (user.user_metadata?.avatar_url && avatarImg) {
                avatarImg.src = user.user_metadata.avatar_url;
                avatarImg.classList.remove("hidden");
                initialsSpan?.classList.add("hidden");
            }
        }

        updateNameBtn?.addEventListener("click", async () => {
            const newName = nameInput.value.trim();
            if (!newName) return;
            updateNameBtn.textContent = "Updating...";
            const { error } = await supabase.auth.updateUser({
                data: { full_name: newName },
            });
            if (error) alert("Error: " + error.message);
            else {
                alert("Profile updated!");
                window.location.reload();
            }
        });

        // Reveal confirmation area
        deleteBtnInit?.addEventListener("click", () => {
            console.log("Delete UI: Showing confirmation area");
            deleteBtnInit.parentElement?.classList.add("hidden");
            deleteArea?.classList.remove("hidden");
        });

        // Hide confirmation area
        cancelDeleteBtn?.addEventListener("click", () => {
            console.log("Delete UI: Cancelling");
            deleteArea?.classList.add("hidden");
            deleteBtnInit?.parentElement?.classList.remove("hidden");
        });

        // Final deletion
        deleteBtnFinal?.addEventListener("click", async () => {
            console.log("DELETE_FINAL: Button clicked");

            if (deleteBtnFinal) {
                deleteBtnFinal.textContent = "PROCESSING...";
                (deleteBtnFinal as HTMLButtonElement).disabled = true;
            }

            try {
                console.log(
                    "DELETE_DIAGNOSTIC: Supabase URL used by client:",
                    (supabase as any).supabaseUrl,
                );
                console.log(
                    "DELETE_DIAGNOSTIC: Current User ID:",
                    (await supabase.auth.getUser()).data.user?.id,
                );
                console.log(
                    "DELETE_FINAL: Step 1 - Calling Supabase RPC 'delete_user_final'",
                );

                const { error: rpcError, data } =
                    await supabase.rpc("delete_user_final");

                if (rpcError) {
                    console.error("DELETE_FINAL: RPC ERROR", rpcError);
                    throw new Error(
                        `Database Error: ${rpcError.message} (${rpcError.code})`,
                    );
                }

                console.log("DELETE_FINAL: Step 2 - RPC Success", data);
                // alert("Debug: Database record deleted. Now clearing your session...");

                console.log("DELETE_FINAL: Step 3 - Clearing Local Storage");
                localStorage.clear();
                sessionStorage.clear();

                console.log(
                    "DELETE_FINAL: Step 4 - Calling supabase.auth.signOut()",
                );
                try {
                    await supabase.auth.signOut();
                } catch (soerr) {
                    console.warn(
                        "DELETE_FINAL: SignOut failed (expected if user is gone)",
                        soerr,
                    );
                }

                console.log("DELETE_FINAL: Step 5 - Redirecting");
                alert(
                    "SUCCESS: Your account has been deleted. Redirecting to home page...",
                );
                window.location.href = "/";
            } catch (err: any) {
                console.error("DELETE_FINAL: CRITICAL CATCH", err);
                alert(
                    "❌ DELETION FAILED!\n\nReason: " +
                        err.message +
                        "\n\nPlease check the console (F12) and send me the logs.",
                );
                if (deleteBtnFinal) {
                    deleteBtnFinal.textContent = "YES, DELETE PERMANENTLY";
                    (deleteBtnFinal as HTMLButtonElement).disabled = false;
                }
            }
        });

        logoutBtn?.addEventListener("click", () => {
            supabase.auth.signOut().then(() => (window.location.href = "/"));
        });

        init();
    </script>
</Layout>
